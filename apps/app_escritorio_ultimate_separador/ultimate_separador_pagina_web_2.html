<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Separador de PDF en ZIP</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #1a1a1a;
      color: #eee;
      text-align: center;
      padding: 40px;
    }
    .container {
      background: #2b2b2b;
      padding: 20px;
      border-radius: 12px;
      max-width: 500px;
      margin: auto;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
    }
    input, button {
      margin: 10px 0;
      padding: 10px;
      width: 80%;
      border-radius: 8px;
      border: none;
      font-size: 14px;
    }
    button {
      background: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Separador de PDF en ZIP</h2>
    <input type="file" id="pdfFiles" multiple accept="application/pdf"><br>
    <input type="text" id="fecha" placeholder="Ingrese fecha (texto)"><br>
    <input type="text" id="numero" placeholder="Ingrese número de archivo (texto)"><br>
    <button onclick="procesarPDFs()">Generar ZIP</button>
  </div>

  <script>
    function extractTitular(text) {
      const patterns = [
        /UXILIAR DEL\s+Titular de la cuenta:\s*([A-Z\s]+)/,
        /SA DE CV\s+Titular de la cuenta:\s*([A-Z\s]+)/,
        /\nCREDITO\s+Titular de la cuenta:\s*([A-Z\s]+)/,
        /\nCV\s+Titular de la cuenta:\s*([A-Z\s]+)/,
        /DEL\s+Titular de la cuenta:\s*([A-Z\s]+)/
      ];
      for (let regex of patterns) {
        const match = text.match(regex);
        if (match) {
          return match[1].trim().replace(/\s+/g, "_");
        }
      }
      return null;
    }

    async function getPageText(pdfjsDoc, pageNum) {
      const page = await pdfjsDoc.getPage(pageNum);
      const textContent = await page.getTextContent();
      return textContent.items.map(item => item.str).join(" ");
    }

    async function procesarPDFs() {
      const files = document.getElementById("pdfFiles").files;
      const fecha = document.getElementById("fecha").value.trim();
      const numero = document.getElementById("numero").value.trim();

      if (!files.length) {
        alert("Seleccione al menos un PDF.");
        return;
      }
      if (!fecha || !numero) {
        alert("Ingrese fecha y número de archivo.");
        return;
      }

      const zip = new JSZip();

      for (let file of files) {
        const arrayBuffer = await file.arrayBuffer();

        // PDF-lib para dividir páginas
        const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
        const totalPages = pdfDoc.getPageCount();

        // PDF.js para extraer texto
        const pdfjsDoc = await pdfjsLib.getDocument({data: arrayBuffer}).promise;

        const baseName = file.name.replace(".pdf","");

        for (let i = 0; i < totalPages; i++) {
          const newPdf = await PDFLib.PDFDocument.create();
          const [copiedPage] = await newPdf.copyPages(pdfDoc, [i]);
          newPdf.addPage(copiedPage);

          // Extraer texto de la página
          const text = await getPageText(pdfjsDoc, i + 1);
          let titular = extractTitular(text);
          if (!titular) {
            titular = `Desconocido_${i+1}`;
          }

          // Nombre de archivo único en la raíz del ZIP
          const filename = `${fecha}_${baseName}_${titular}_${i+1}.pdf`;
          const pdfBytes = await newPdf.save();
          zip.file(filename, pdfBytes);
        }
      }

      const zipBlob = await zip.generateAsync({type:"blob"});
      saveAs(zipBlob, `PROVEEDORES_${fecha}_${numero}.zip`);
    }
  </script>
</body>
</html>
